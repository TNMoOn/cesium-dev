/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-0488ac89","./Check-78ca6843","./Math-8a4c9da1","./Cartesian2-cc1e6450","./defineProperties-c6a70625","./Transforms-1e8bb4c5","./RuntimeError-4d6e0952","./WebGLConstants-66e14a3b","./ComponentDatatype-9252f28f","./AttributeCompression-fe1560e2","./IndexDatatype-8575c917","./IntersectionTests-b81b9813","./Plane-112f7911","./WebMercatorProjection-c0de4fbc","./createTaskProcessorWorker","./EllipsoidTangentPlane-f27da5bc","./OrientedBoundingBox-521bb99d","./TerrainEncoding-c442f7a9"],function(fe,e,pe,ye,t,xe,r,i,n,Ne,Me,a,o,be,s,Ce,ve,we){"use strict";var Ee=32767,Ae=new ye.Cartesian3,Pe=new ye.Cartesian3,Se=new ye.Cartesian3,Be=new ye.Cartographic,Fe=new ye.Cartesian2,Ve=new ye.Cartesian3,He=new xe.Matrix4,We=new xe.Matrix4;function _e(e,t,r,i,n,a,o,s,c){var u=Number.POSITIVE_INFINITY,d=n.north,h=n.south,m=n.east,l=n.west;m<l&&(m+=pe.CesiumMath.TWO_PI);for(var I=e.length,g=0;g<I;++g){var T=e[g],f=r[T],p=i[T];Be.longitude=pe.CesiumMath.lerp(l,m,p.x),Be.latitude=pe.CesiumMath.lerp(h,d,p.y),Be.height=f-t;var y=a.cartographicToCartesian(Be,Ae);xe.Matrix4.multiplyByPoint(o,y,y),ye.Cartesian3.minimumByComponent(y,s,s),ye.Cartesian3.maximumByComponent(y,c,c),u=Math.min(u,Be.height)}return u}function ke(e,t,r,i,n,a,o,s,c,u,d,h,m,l,I,g,T,f){var p,y,x;x=m?(p=n.length-1,y=-1):(p=0,y=n.length,1);var N=-1,M=fe.defined(c),b=t/a.getStride(),C=d.north,v=d.south,w=d.east,E=d.west;w<E&&(w+=pe.CesiumMath.TWO_PI);for(var A=p;A!==y;A+=x){var P=n[A],S=o[P],B=s[P];Be.longitude=pe.CesiumMath.lerp(E,w,B.x)+T,Be.latitude=pe.CesiumMath.lerp(v,C,B.y)+f,Be.height=S-h;var F,V=u.cartographicToCartesian(Be,Ae);if(M){var H=2*P;if(Fe.x=c[H],Fe.y=c[1+H],1!==l){var W=Ne.AttributeCompression.octDecode(Fe.x,Fe.y,Ve),_=xe.Transforms.eastNorthUpToFixedFrame(Ae,u,We),k=xe.Matrix4.inverseTransformation(_,He);xe.Matrix4.multiplyByPointAsVector(k,W,W),W.z*=l,ye.Cartesian3.normalize(W,W),xe.Matrix4.multiplyByPointAsVector(_,W,W),ye.Cartesian3.normalize(W,W),Ne.AttributeCompression.octEncode(W,Fe)}}a.hasWebMercatorT&&(F=(be.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Be.latitude)-I)*g),t=a.encode(e,t,V,B,Be.height,Fe,F),-1!==N&&(r[i++]=N,r[i++]=b-1,r[i++]=P,r[i++]=b-1,r[i++]=b,r[i++]=P),N=P,++b}return i}function Oe(e,t){var r;return"function"==typeof e.slice&&"function"!=typeof(r=e.slice()).sort&&(r=void 0),fe.defined(r)||(r=Array.prototype.slice.call(e)),r.sort(t),r}return s(function(e,t){var r,i,n=e.quantizedVertices,a=n.length/3,o=e.octEncodedNormals,s=e.westIndices.length+e.eastIndices.length+e.southIndices.length+e.northIndices.length,c=e.includeWebMercatorT,u=ye.Rectangle.clone(e.rectangle),d=u.west,h=u.south,m=u.east,l=u.north,I=ye.Ellipsoid.clone(e.ellipsoid),g=e.exaggeration,T=e.minimumHeight*g,f=e.maximumHeight*g,p=e.relativeToCenter,y=xe.Transforms.eastNorthUpToFixedFrame(p,I),x=xe.Matrix4.inverseTransformation(y,new xe.Matrix4);c&&(r=be.WebMercatorProjection.geodeticLatitudeToMercatorAngle(h),i=1/(be.WebMercatorProjection.geodeticLatitudeToMercatorAngle(l)-r));var N=n.subarray(0,a),M=n.subarray(a,2*a),b=n.subarray(2*a,3*a),C=fe.defined(o),v=new Array(a),w=new Array(a),E=new Array(a),A=c?new Array(a):[],P=Pe;P.x=Number.POSITIVE_INFINITY,P.y=Number.POSITIVE_INFINITY,P.z=Number.POSITIVE_INFINITY;var S=Se;S.x=Number.NEGATIVE_INFINITY,S.y=Number.NEGATIVE_INFINITY,S.z=Number.NEGATIVE_INFINITY;for(var B=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,V=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,W=0;W<a;++W){var _=N[W],k=M[W],O=_/Ee,Y=k/Ee,z=pe.CesiumMath.lerp(T,f,b[W]/Ee);Be.longitude=pe.CesiumMath.lerp(d,m,O),Be.latitude=pe.CesiumMath.lerp(h,l,Y),Be.height=z,B=Math.min(Be.longitude,B),F=Math.max(Be.longitude,F),V=Math.min(Be.latitude,V),H=Math.max(Be.latitude,H);var G=I.cartographicToCartesian(Be);v[W]=new ye.Cartesian2(O,Y),w[W]=z,E[W]=G,c&&(A[W]=(be.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Be.latitude)-r)*i),xe.Matrix4.multiplyByPoint(x,G,Ae),ye.Cartesian3.minimumByComponent(Ae,P,P),ye.Cartesian3.maximumByComponent(Ae,S,S)}var j,D,L,U=Oe(e.westIndices,function(e,t){return v[e].y-v[t].y}),R=Oe(e.eastIndices,function(e,t){return v[t].y-v[e].y}),q=Oe(e.southIndices,function(e,t){return v[t].x-v[e].x}),J=Oe(e.northIndices,function(e,t){return v[e].x-v[t].x});1!==g&&(D=xe.BoundingSphere.fromPoints(E),j=ve.OrientedBoundingBox.fromRectangle(u,T,f,I)),(1!==g||T<0)&&(L=new we.EllipsoidalOccluder(I).computeHorizonCullingPointPossiblyUnderEllipsoid(p,E,T));var K=T;K=Math.min(K,_e(e.westIndices,e.westSkirtHeight,w,v,u,I,x,P,S)),K=Math.min(K,_e(e.southIndices,e.southSkirtHeight,w,v,u,I,x,P,S)),K=Math.min(K,_e(e.eastIndices,e.eastSkirtHeight,w,v,u,I,x,P,S)),K=Math.min(K,_e(e.northIndices,e.northSkirtHeight,w,v,u,I,x,P,S));for(var Q=new Ce.AxisAlignedBoundingBox(P,S,p),X=new we.TerrainEncoding(Q,K,f,y,C,c),Z=X.getStride(),$=new Float32Array(a*Z+s*Z),ee=0,te=0;te<a;++te){if(C){var re=2*te;if(Fe.x=o[re],Fe.y=o[1+re],1!==g){var ie=Ne.AttributeCompression.octDecode(Fe.x,Fe.y,Ve),ne=xe.Transforms.eastNorthUpToFixedFrame(E[te],I,We),ae=xe.Matrix4.inverseTransformation(ne,He);xe.Matrix4.multiplyByPointAsVector(ae,ie,ie),ie.z*=g,ye.Cartesian3.normalize(ie,ie),xe.Matrix4.multiplyByPointAsVector(ne,ie,ie),ye.Cartesian3.normalize(ie,ie),Ne.AttributeCompression.octEncode(ie,Fe)}}ee=X.encode($,ee,E[te],v[te],w[te],Fe,A[te])}var oe=Math.max(0,2*(s-4)),se=e.indices.length+3*oe,ce=Me.IndexDatatype.createTypedArray(a+s,se);ce.set(e.indices,0);var ue=1e-4*(F-B),de=1e-4*(H-V),he=-ue,me=ue,le=de,Ie=-de,ge=a*Z,Te=e.indices.length;return Te=ke($,ge,ce,Te,e.westIndices,X,w,v,o,I,u,e.westSkirtHeight,!0,g,r,i,he,0),Te=ke($,ge+=e.westIndices.length*Z,ce,Te,e.southIndices,X,w,v,o,I,u,e.southSkirtHeight,!1,g,r,i,0,Ie),Te=ke($,ge+=e.southIndices.length*Z,ce,Te,e.eastIndices,X,w,v,o,I,u,e.eastSkirtHeight,!1,g,r,i,me,0),ke($,ge+=e.eastIndices.length*Z,ce,Te,e.northIndices,X,w,v,o,I,u,e.northSkirtHeight,!0,g,r,i,0,le),t.push($.buffer,ce.buffer),{vertices:$.buffer,indices:ce.buffer,westIndicesSouthToNorth:U,southIndicesEastToWest:q,eastIndicesNorthToSouth:R,northIndicesWestToEast:J,vertexStride:Z,center:p,minimumHeight:T,maximumHeight:f,boundingSphere:D,orientedBoundingBox:j,occludeePointInScaledSpace:L,encoding:X,skirtIndex:e.indices.length}})});
